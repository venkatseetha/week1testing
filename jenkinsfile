pipeline {
    agent any
    
    environment {
        REPO_URL = 'https://github.com/your/repo.git'  // Your repository URL
        BRANCH_AGE_DAYS = 180  // Set to 30 for 30 days, 180 for 6 months
    }
    
    stages {
        stage('Clone Repository') {
            steps {
                // Clone the repository
                git url: "${env.REPO_URL}", credentialsId: 'your-credentials-id'
            }
        }
        
        stage('Delete Old Branches') {
            steps {
                script {
                    // Fetch all branches
                    sh 'git fetch --all'

                    // Get the current date in Unix timestamp
                    def currentDate = new Date().getTime()

                    // Get the list of branches
                    def branches = sh(script: 'git for-each-ref --format="%(refname:short) %(committerdate:unix)" refs/remotes/origin', returnStdout: true).trim().split('\n')

                    for (branch in branches) {
                        def parts = branch.split(' ')
                        def branchName = parts[0].replaceAll('^origin/', '')
                        def lastCommitDate = parts[1].toLong() * 1000

                        // Calculate branch age in days
                        def branchAgeDays = (currentDate - lastCommitDate) / (1000 * 60 * 60 * 24)

                        if (branchAgeDays > env.BRANCH_AGE_DAYS.toInteger() && branchName != 'main' && branchName != 'master') {
                            // Delete the branch if it is older than the specified age and not the main/master branch
                            sh "git push origin --delete ${branchName}"
                            echo "Deleted branch: ${branchName} (Age: ${branchAgeDays} days)"
                        } else {
                            echo "Skipping branch: ${branchName} (Age: ${branchAgeDays} days)"
                        }
                    }
                }
            }
        }
    }
    
    post {
        cleanup {
            // Clean up the workspace after the build
            deleteDir()
        }
    }
}
